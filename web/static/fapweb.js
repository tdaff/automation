/*jslint browser:true */

/** Just put this as a global for now so accessible from all functions*/
var jmolApplet0;


/** Take all the fields and create the fap file */
function generateFap() {
    "use strict";
    var fapfile = '#\n# .fap file generated by faps web UI\n#\n\n',
        formsCollection = document.getElementById('all-options'),
        form_id,
        item_id;

    for (form_id = 0; form_id < formsCollection.length; form_id += 1) {
        if (!formsCollection[form_id].disabled) {
            fapfile += formsCollection[form_id].id;
            fapfile += " = ";
            if (formsCollection[form_id].type === 'checkbox') {
                if (formsCollection[form_id].checked === true) {
                    fapfile += 'True';
                } else {
                    fapfile += 'False';
                }
            } else if (formsCollection[form_id].id === 'guests') {
                for (item_id = 0; item_id < formsCollection[form_id].length; item_id += 1) {
                    if (formsCollection[form_id][item_id].selected) {
                        fapfile += formsCollection[form_id][item_id].value;
                        fapfile += ' ';
                    }
                }
            } else {
                fapfile += formsCollection[form_id].value;
            }
            fapfile += '\n';
        }
    }
    return fapfile;
}

/** update the textarea in the page with the newest fap file */
function updateFap() {
    "use strict";
    var textArea = document.getElementById('generated-file');
    textArea.innerHTML = generateFap();
}


function switchActive(control) {
    "use strict";
    var input = document.getElementById(control);
    input.disabled = !input.disabled;
    updateFap();
}


function submitJob() {
    "use strict";
    var fileInput = document.getElementById('job-form'),
        btn = document.getElementById('submit-btn'),
        formData = new FormData(fileInput),
        xhr = new XMLHttpRequest(),
        oldText;

    btn.disabled = true;
    oldText = btn.innerHTML;
    btn.innerHTML = 'Submitting...';
    xhr.open('post', '/faps/submit', true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            window.alert(xhr.responseText);
            btn.disabled = false;
            btn.innerHTML = oldText;
        }
    };
    xhr.send(formData);
    /* do something after */
}

/** read in the file contents and inject into the page as a new script */
function viewCif() {
    "use strict";
    var fileInput = document.getElementById('cif-file').files[0],
        reader = new FileReader();

    reader.readAsText(fileInput, "UTF-8");
    reader.onload = function (evt) {
        var cifFile = evt.target.result,
            myCanvas = new ChemDoodle.TransformCanvas3D('view-cif', 500, 300),
            unitCell;

        myCanvas.emptyMessage = 'No Data Loaded!';
        myCanvas.specs.projectionPerspective_3D = false;
        myCanvas.specs.atoms_useJMOLColors = true;
        myCanvas.specs.bonds_useJMOLColors = true;

        cifFile = cifFile.replace(/(\r\n|\n|\t)/gm, "\n");
        cifFile = cifFile.replace(/[\'\"]/g, "\\$&");
        unitCell = ChemDoodle.readCIF(cifFile);
        myCanvas.loadMolecule(unitCell);
        myCanvas.repaint();
    };

}

function jmolSetup() {
    "use strict";
    var Info = {
        width: 500,
        height: 300,
        // serverURL: "http://chemapps.stolaf.edu/jmol/jsmol/jsmol.php ",
        // serverURL: "http://propka.ki.ku.dk/~jhjensen/jsmol/jsmol.php ",
        use: "HTML5",
        j2sPath: "faps/static/jsmol/j2s",
        console: "jmolApplet0_infodiv"
    };
    jmolApplet0 = Jmol.getApplet("jmolApplet0", Info);
}

function viewCif2() {
    "use strict";
    var fileInput = document.getElementById('cif-file').files[0],
        reader = new FileReader();

    reader.readAsText(fileInput, "UTF-8");
    reader.onload = function (evt) {
        var cifFile = evt.target.result;

        cifFile = cifFile.replace(/(\r\n|\n|\t)/gm, "\n");
        cifFile = cifFile.replace(/[\'\"]/g, "\\$&");
        Jmol.script(jmolApplet0, 'load inline \"' + cifFile + '\" {1 1 1} packed');
    };

}
